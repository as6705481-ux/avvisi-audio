{% extends "layout.html" %}
{% block content %}
<style>
  form { max-width: 720px; margin:0 auto; background:#fff5e6; border:1px solid #ffc107; padding:20px; border-radius:8px; }
  h1 { text-align:center; color:#ff8c00; font-family:'Poppins',sans-serif; margin-bottom:20px; }
  .btn-orange { background:#ff8c00; border-color:#ff8c00; color:#fff; }
  .btn-orange:hover { background:#e67e00; border-color:#e67e00; color:#fff; }
</style>

<div class="container mt-4">
  <h1>Nuevo Evento</h1>
  <form method="POST" class="mt-3">
    <div class="mb-3">
      <label class="form-label">Nombre del evento</label>
      <input type="text" name="name" class="form-control" required placeholder="Ej. Boda López-Martínez">
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Cliente</label>
        <select name="client_id" id="clientSel" class="form-select" required>
          {% for c in clients %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Contacto</label>
        <select name="contact_id" id="contactSel" class="form-select">
          <option value="">—</option>
          {% for k in contacts %}<option value="{{ k.id }}" data-client="{{ k.client_id }}">{{ k.name }}</option>{% endfor %}
        </select>
        <small class="text-muted">Se filtra por cliente.</small>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Venue</label>
      <input type="text" name="venue" class="form-control" placeholder="Hotel / Salón / Dirección">
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Inicio</label>
        <input type="datetime-local" name="start_at" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Fin</label>
        <input type="datetime-local" name="end_at" class="form-control" required>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-md-6">
        <label class="form-label">Inicio de montaje (opcional)</label>
        <input type="datetime-local" name="build_start_at" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label">Fin desmontaje (opcional)</label>
        <input type="datetime-local" name="strike_end_at" class="form-control">
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-md-6">
        <label class="form-label">Zona horaria</label>
        <input type="text" name="timezone" value="{{ tz_default }}" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label">Creado por</label>
        <select name="created_by" class="form-select">
          <option value="">—</option>
          {% for o in owners %}<option value="{{ o.id }}">{{ o.full_name }}</option>{% endfor %}
        </select>
      </div>
    </div>

    <div class="mb-3 mt-2">
      <label class="form-label">Notas</label>
      <textarea name="notes" class="form-control" rows="2" placeholder="Notas para operación, accesos, etc."></textarea>
    </div>

    <div class="d-flex justify-content-between">
      <a href="{{ url_for('events') }}" class="btn btn-secondary">Cancelar</a>
      <button class="btn btn-orange">Crear evento</button>
    </div>
  </form>
</div>

<script>
  // Filtra contactos por cliente
  (function(){
    const clientSel  = document.getElementById('clientSel');
    const contactSel = document.getElementById('contactSel');
    function filterContacts(){
      const cid = clientSel.value;
      [...contactSel.options].forEach(opt => {
        if(!opt.value) { opt.hidden = false; return; }
        opt.hidden = (opt.dataset.client !== cid);
      });
      // limpiar selección si no corresponde
      if (contactSel.selectedOptions.length && contactSel.selectedOptions[0].hidden) {
        contactSel.value = "";
      }
    }
    clientSel.addEventListener('change', filterContacts);
    filterContacts();
  })();
</script>
{% endblock %}
