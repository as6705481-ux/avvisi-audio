{% extends "layout.html" %}
{% block content %}
<style>
  form { max-width: 980px; margin: 0 auto; background:#fff5e6; border:1px solid #ffc107; padding:20px; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,.1); }
  h1 { text-align:center; color:#ff8c00; font-family:'Poppins',sans-serif; margin-bottom:20px; }
  .btn-orange { background:#ff8c00; border-color:#ff8c00; color:#fff; }
  .btn-orange:hover { background:#e67e00; border-color:#e67e00; color:#fff; }
  .table thead th { white-space: nowrap; }
</style>

<div class="container mt-5">
  <h1>Nueva Cotización</h1>
  <form method="POST" class="mt-3" id="quoteForm">
    <!-- CABECERA -->
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Cliente</label>
        <select name="client_id" class="form-select" required>
          {% for c in clients %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Contacto</label>
        <select name="contact_id" class="form-select">
          <option value="">—</option>
          {% for c in contacts %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Evento</label>
        <select name="event_id" class="form-select">
          <option value="">—</option>
          {% for e in events %}<option value="{{ e.id }}">{{ e.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Propietario</label>
        <select name="owner_id" class="form-select" required>
          {% for o in owners %}<option value="{{ o.id }}">{{ o.full_name }}</option>{% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Moneda</label>
        <input name="currency" value="{{ default_currency }}" class="form-control" maxlength="3">
      </div>
      <div class="col-md-3">
        <label class="form-label">T.Cambio</label>
        <input name="exchange_rate" type="number" step="1" value="1.000000" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Validez hasta</label>
        <input name="valid_until" type="date" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Anticipo (L)</label>
        <input name="deposit_due" type="number" step="1" value="0.00" class="form-control">
      </div>

      <div class="col-12">
        <label class="form-label">Términos</label>
        <textarea name="terms" class="form-control" rows="2"></textarea>
      </div>
      <div class="col-12">
        <label class="form-label">Notas internas</label>
        <textarea name="notes_internal" class="form-control" rows="2"></textarea>
      </div>
      <div class="col-12">
        <label class="form-label">Notas para el cliente</label>
        <textarea name="notes_client" class="form-control" rows="2"></textarea>
      </div>
    </div>

    <!-- LÍNEAS / PRODUCTOS -->
    <hr class="my-4">
    <h5>Productos / Ítems</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle" id="linesTable">
        <thead class="table-light">
          <tr>
            <th style="min-width: 260px;">Ítem</th>
            <th style="width:110px;">Cantidad</th>
            <th style="width:130px;">Precio</th>
            <th style="width:120px;">Impuesto %</th>
            <th style="width:110px;">Desc %</th>
            <th style="min-width: 200px;">Sección</th>
            <th style="min-width: 260px;">Descripción</th>
            <th style="width: 60px;"></th>
          </tr>
        </thead>
        <tbody>
          <!-- fila inicial -->
          <tr>
            <td>
              <select name="item_id[]" class="form-select">
                <option value="">— Selecciona ítem —</option>
                {% for it in items %}
                  <option value="{{ it.id }}"
                    data-default-rate="{{ it.default_rate }}"
                    data-tax-rate="{{ it.tax_rate }}">
                    {{ it.sku }} — {{ it.name }}
                  </option>
                {% endfor %}
              </select>
            </td>
            <td><input name="quantity[]" type="number" step="1" value="1" class="form-control"></td>
            <td><input name="unit_price[]" type="number" step="1" class="form-control" placeholder="auto"></td>
            <td><input name="tax_rate[]" type="number" step="1" class="form-control" placeholder="auto"></td>
            <td><input name="discount_pct[]" type="number" step="1" value="0" class="form-control"></td>
            <td><input name="section[]" class="form-control" placeholder="Audio / Video / Rigging"></td>
            <td><input name="line_description[]" class="form-control" placeholder="Detalle visible al cliente (opcional)"></td>
            <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)">X</button></td>
          </tr>
        </tbody>
      </table>
    </div>


    <div class="d-flex justify-content-between">
      <button type="button" class="btn btn-outline-secondary" onclick="addLine()">Agregar fila</button>
      <div>
        <a href="{{ url_for('quotations') }}" class="btn btn-secondary">Cancelar</a>
        <button class="btn btn-orange">Crear cotización</button>
      </div>
    </div>
  </form>
</div>

<script>
  function addLine(){
    const tbody = document.querySelector("#linesTable tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <select name="item_id[]" class="form-select">
          <option value="">— Selecciona ítem —</option>
          {% for it in items %}
            <option value="{{ it.id }}"
              data-default-rate="{{ it.default_rate }}"
              data-tax-rate="{{ it.tax_rate }}">
              {{ it.sku }} — {{ it.name }}
            </option>
          {% endfor %}
        </select>
      </td>
      <td><input name="quantity[]" type="number" step="1" value="1" class="form-control"></td>
      <td><input name="unit_price[]" type="number" step="1" class="form-control" placeholder="auto"></td>
      <td><input name="tax_rate[]" type="number" step="1" class="form-control" placeholder="auto"></td>
      <td><input name="discount_pct[]" type="number" step="1" value="0" class="form-control"></td>
      <td><input name="section[]" class="form-control" placeholder="Audio / Video / Rigging"></td>
      <td><input name="line_description[]" class="form-control" placeholder="Detalle visible al cliente (opcional)"></td>
      <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)">X</button></td>
    `;
    tbody.appendChild(tr);
  }

  function removeLine(btn){
    const tr = btn.closest("tr");
    const tbody = tr.parentElement;
    if (tbody.children.length > 1) {
      tbody.removeChild(tr);
    } else {
      // limpia la fila única
      tr.querySelectorAll("input").forEach(i => i.value = i.name.includes("quantity") ? 1 : "");
      tr.querySelectorAll("select").forEach(s => s.value = "");
    }
  }
</script>
{% endblock %}
