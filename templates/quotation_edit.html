{% extends "layout.html" %}
{% block content %}
<style>
  .box { background:#fff5e6; border:1px solid #ffc107; padding:16px; border-radius:8px; }
  .btn-orange { background:#ff8c00; border-color:#ff8c00; color:#fff; }
  .btn-orange:hover { background:#e67e00; border-color:#e67e00; color:#fff; }
</style>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">Cotización {{ q.quote_number }}</h3>
    <form action="{{ url_for('quotation_delete', quotation_id=q.id) }}" method="POST" onsubmit="return confirm('¿Eliminar cotización?');">
      <button class="btn btn-outline-danger btn-sm">Eliminar</button>
    </form>
    {% if not q.event_id %}
      <a href="{{ url_for('quote_event_new', quotation_id=q.id) }}"
        class="btn btn-outline-primary">
        <i class="bi bi-calendar-plus"></i> Crear evento desde esta cotización
      </a>
    {% else %}
      <a href="{{ url_for('event_edit', event_id=q.event_id) }}"
        class="btn btn-outline-secondary">
        <i class="bi bi-calendar-event"></i> Ver/editar evento
      </a>
    {% endif %}
  </div>

  <!-- Cabecera -->
  <form method="POST" class="box mb-3">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Cliente</label>
        <select name="client_id" class="form-select">
          {% for c in clients %}<option value="{{ c.id }}" {{ 'selected' if c.id==q.client_id else '' }}>{{ c.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Contacto</label>
        <select name="contact_id" class="form-select">
          <option value="">—</option>
          {% for c in contacts %}<option value="{{ c.id }}" {{ 'selected' if c.id==q.contact_id else '' }}>{{ c.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Evento</label>
        <select name="event_id" class="form-select">
          <option value="">—</option>
          {% for e in events %}<option value="{{ e.id }}" {{ 'selected' if e.id==q.event_id else '' }}>{{ e.name }}</option>{% endfor %}
        </select>
      </div>
      

      <div class="col-md-3">
        <label class="form-label">Propietario</label>
        <select name="owner_id" class="form-select">
          {% for o in owners %}<option value="{{ o.id }}" {{ 'selected' if o.id==q.owner_id else '' }}>{{ o.full_name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Moneda</label>
        <input name="currency" value="{{ q.currency }}" class="form-control" maxlength="3">
      </div>
      <div class="col-md-2">
        <label class="form-label">T.Cambio</label>
        <input name="exchange_rate" type="number" step="0.000001" value="{{ q.exchange_rate }}" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Validez hasta</label>
        <input name="valid_until" type="date" value="{{ q.valid_until }}" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label">Anticipo (L)</label>
        <input name="deposit_due" type="number" step="0.01" value="{{ q.deposit_due }}" class="form-control">
      </div>

      <div class="col-12">
        <label class="form-label">Términos</label>
        <textarea name="terms" class="form-control" rows="2">{{ q.terms or '' }}</textarea>
      </div>
      <div class="col-12">
        <label class="form-label">Notas internas</label>
        <textarea name="notes_internal" class="form-control" rows="2">{{ q.notes_internal or '' }}</textarea>
      </div>
      <div class="col-12">
        <label class="form-label">Notas cliente</label>
        <textarea name="notes_client" class="form-control" rows="2">{{ q.notes_client or '' }}</textarea>
      </div>
    </div>
    <div class="d-flex justify-content-between mt-3">
      <a href="{{ url_for('quotations') }}" class="btn btn-secondary">Volver</a>
      <button class="btn btn-orange">Guardar</button>
    </div>
  </form>

  <!-- Estado -->
  <div class="box mb-3">
    <div class="d-flex align-items-center gap-2">
      <span>Estado actual: <span class="badge bg-info text-dark">{{ q.status }}</span></span>
      <form action="{{ url_for('quotation_set_status', quotation_id=q.id) }}" method="POST" class="d-inline ms-auto">
        <input type="hidden" name="actor_id" value="{{ user.id }}">
        <select name="status" class="form-select form-select-sm d-inline-block" style="width:auto;">
          <option disabled selected>Cambiar a…</option>
          <option value="sent">sent</option>
          <option value="accepted">accepted</option>
          <option value="declined">declined</option>
          <option value="expired">expired</option>
          <option value="cancelled">cancelled</option>
          <option value="converted">converted</option>
        </select>
        <input name="note" class="form-control form-control-sm d-inline-block" style="width:260px;" placeholder="Nota (opcional)">
        <button class="btn btn-sm btn-outline-primary">Aplicar</button>
      </form>
    </div>
  </div>

  <!-- Agregar línea -->
  <form method="POST" class="box mb-3">
    <input type="hidden" name="action" value="add_line">
    <div class="row g-2">
      <div class="col-md-5">
        <label class="form-label">Ítem</label>
        <select name="item_id" class="form-select">
          {% for it in items %}
          <option value="{{ it.id }}">{{ it.sku }} — {{ it.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Cantidad</label>
        <input name="quantity" type="number" step="0.01" value="1" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label">Desc %</label>
        <input name="discount_pct" type="number" step="0.01" value="0" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Sección</label>
        <input name="section" class="form-control" placeholder="Audio / Video / Rigging">
      </div>
      <div class="col-12">
        <label class="form-label">Descripción</label>
        <input name="line_description" class="form-control" placeholder="Detalle para el cliente (opcional)">
      </div>
    </div>
    <div class="mt-2 text-end">
      <button class="btn btn-orange">Agregar línea</button>
    </div>
  </form>

  <!-- Líneas -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead>
        <tr>
          <th>Ítem</th><th>Cant</th><th>U</th><th>P.Unit</th><th>Desc%</th><th>Imp%</th><th>Subtotal</th><th>Impuesto</th><th>Total</th><th></th>
        </tr>
      </thead>
      <tbody>
        {% for ln in lines %}
        <tr>
          <form action="{{ url_for('quotation_line_update', quotation_id=q.id, line_id=ln.id) }}" method="POST">
            <td><input name="custom_name" value="{{ ln.custom_name }}" class="form-control form-control-sm"></td>
            <td style="width:80px;"><input name="quantity" type="number" step="0.01" value="{{ ln.quantity }}" class="form-control form-control-sm"></td>
            <td style="width:90px;"><input name="unit" value="{{ ln.unit }}" class="form-control form-control-sm"></td>
            <td style="width:120px;"><input name="unit_price" type="number" step="0.01" value="{{ ln.unit_price }}" class="form-control form-control-sm"></td>
            <td style="width:100px;"><input name="discount_pct" type="number" step="0.01" value="{{ ln.discount_pct }}" class="form-control form-control-sm"></td>
            <td style="width:100px;"><input name="tax_rate" type="number" step="0.01" value="{{ ln.tax_rate }}" class="form-control form-control-sm"></td>
            <td>{{ '%.2f'|format(ln.line_subtotal or 0) }}</td>
            <td>{{ '%.2f'|format(ln.line_tax or 0) }}</td>
            <td>{{ '%.2f'|format(ln.line_total or 0) }}</td>
            <td class="text-nowrap">
              <button class="btn btn-sm btn-outline-primary">Guardar</button>
              <form action="{{ url_for('quotation_line_delete', quotation_id=q.id, line_id=ln.id) }}" method="POST" class="d-inline">
                <button class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar línea?');">Eliminar</button>
              </form>
            </td>
          </form>
        </tr>
        {% else %}
        <tr><td colspan="10" class="text-center text-muted py-4">No hay líneas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Totales -->
  <div class="box">
    <div class="row">
      <div class="col-md-8"></div>
      <div class="col-md-4">
        <div class="d-flex justify-content-between"><span>Subtotal:</span><strong>{{ '%.2f'|format(q.subtotal or 0) }}</strong></div>
        <div class="d-flex justify-content-between"><span>Descuentos:</span><strong>{{ '%.2f'|format(q.discount_total or 0) }}</strong></div>
        <div class="d-flex justify-content-between"><span>Impuestos:</span><strong>{{ '%.2f'|format(q.tax_total or 0) }}</strong></div>
        <div class="d-flex justify-content-between fs-5"><span>Total:</span><strong>{{ '%.2f'|format(q.total or 0) }}</strong></div>
      </div>
    </div>
  </div>
  
</div>
{% endblock %}
